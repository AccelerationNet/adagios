{% extends "base.html" %}

{% block title %}Adagios - Object Browser{% endblock %}
{% block footer %}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">

    var currenttab = '#service';
    var currenttable = '#service';


    $(document).ready(function() {
        /* Default class modification */
        $.extend( $.fn.dataTableExt.oStdClasses, {
            "sSortAsc": "header headerSortDown",
            "sSortDesc": "header headerSortUp",
            "sSortable": "header"
        } );

        // Show service tab
        var anchor = document.location.href.split('#')[1];
        if (anchor == undefined) {
            anchor = 'service';
        }


        $('#objecttabs a:[href="#' + anchor + '"]').tab('show');

        $('table#service').adagios_ob_configure_dataTable(
                [
                    { "sTitle": "Host" },
                    { "sTitle": "Name" },
                    { "sTitle": "Command" }
                ],
                [
                    {
                        "object_type": 'service',
                        "rows": [
                            { "cName": "host_name" },
                            {
                                "cName": "service_description",
                                "cAltName": "name",
                                "icon": "glyph-computer-service"
                            },
                            {
                                "cName": "check_command",
                                "truncate": 16
                            }
                        ]
                    },
                    {
                        "object_type": 'servicegroup',
                        "rows": [
                            { "cName": "host_name" },
                            {
                                "cName": "servicegroup_name",
                                "cAltName": "name",
                                "icon": "glyph-more-items"
                            },
                            { "cName": "check_command" }
                        ]
                    }

                ]
        );
        $('table#command').adagios_ob_configure_dataTable(
                [
                    { "sTitle": "Command Name" },
                    { "sTitle": "Command Line" }
                ],
                [
                    {
                        'object_type': 'command',
                        'rows': [
                            {
                                "cName": "command_name",
                                "icon": "glyph-computer-proces"
                            },
                            {
                                "cName": "command_line",
                                "truncate": 40
                            }
                        ]
                    }
                ]
        );

        $('table#contact').adagios_ob_configure_dataTable(
                [
                    { "sTitle": "Contact Name" },
                    { "sTitle": "Alias" },
                    { "sTitle": "E-Mail" }
                ],
                [
                    {
                        'object_type': 'contact',
                        'rows': [
                            {
                                "cName": "contact_name",
                                "cAltName": "name",
                                "icon": "glyph-woman"
                            },
                            { "cName": "alias" },
                            { "cName": "email" }
                        ]
                    },
                    {
                        'object_type': 'contactgroup',
                        'rows': [
                            {
                                "cName": "contactgroup_name",
                                "cAltName": "name",
                                "icon": "glyph-adress-book"
                            },
                            { "cName": "alias" },
                            { "cName": "email" }
                        ]
                    }
                ]
        );
        $('table#host').adagios_ob_configure_dataTable(
                [
                    { "sTitle": "Name" },
                    { "sTitle": "Address" },
                    { "sTitle": "Alias" }
                ],
                [
                    {
                        'object_type': 'host',
                        'rows': [
                            {
                                "cName": "host_name",
                                "cAltName": "name",
                                "icon": "glyph-computer-locked"
                            },
                            { "cName": "address" },
                            { "cName": "alias" }
                        ]
                    },
                    {
                        'object_type': 'hostgroup',
                        'rows': [
                            {
                                "cName": "hostgroup_name",
                                "cAltName": "name",
                                "icon": "glyph-more-items"
                            },
                            { "cName": "address" },
                            { "cName": "alias" }
                        ]
                    }
                ]
        );
        $('table#timeperiod').adagios_ob_configure_dataTable(
                [
                    { "sTitle": "Name" },
                    { "sTitle": "Alias" }
                ],
                [
                    {
                        'object_type': 'timeperiod',
                        'rows': [
                            {
                                "cName": "timeperiod_name",
                                "cAltName": "name",
                                "icon": "glyph-clock"
                            },
                            { "cName": "alias" }
                        ]
                    }
                ]
        );
        $('table#' + anchor).adagios_ob_render_dataTable();


        $(window).bind('resize', function () {
            /* This blows, couldn't find a good way to do this - tommi */
            $("table#" + currenttable).dataTable().fnAdjustColumnSizing();
            $(currenttab).tab('show');
        } );
        $('a[data-toggle="tab"]').on('show', function (e) {
            //alert($(e.target).attr('href'));
            if ( ! $.fn.DataTable.fnIsDataTable($('table' + $(e.target).attr('href'))[0])) {
                $('table' + $(e.target).attr('href')).adagios_ob_render_dataTable();
            }
            return true;
        });
        $('a[data-toggle="tab"]').on('shown', function (e) {
            currenttab = $(e.target).attr('href');
            currenttable = 'table' + $(e.target).attr('href');
            document.location.hash = $(e.target).attr('href');
            $('#log').append("Set current tab " + currenttable + '<br/>');
            // e.target // activated tab
            // e.relatedTarget // previous tab

            return true;
        });


    } );

    </script>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="span12">
            <div class="block">
                <ul class="breadcrumb">
                    <li>
                        <a href="{{ BASE_URL }}">Home</a> <span class="divider">/</span>
                    </li>
                </ul>
                <h2>
                    <i class="icon-th-large"></i> <small>Object</small> Browser
                </h2>

            </div>
        </div>
    </div>
    {% if object_types %}

        <div class="row">
            <div class="span9">
                <div class="block">
                    <ul class="nav nav-tabs" id="objecttabs">
                        <li><a href="#command" data-toggle="tab">Commands</a></li>
                        <li><a href="#contact" data-toggle="tab">Contacts</a></li>
                        <li><a href="#host" data-toggle="tab">Hosts</a></li>
                        <li><a href="#service" data-toggle="tab">Services</a></li>
                        <li><a href="#timeperiod" data-toggle="tab">Timeperiods</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane" id="command">
                            <div id="loading"><h3>Loading...</h3></div>
                            <table id="command" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="contact">
                            <div id="loading"><h3>Loading...</h3></div>
                            <table id="contact" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="host">
                            <div id="loading"><h3>Loading...</h3></div>
                            <table id="host" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="service">
                            <div id="loading"><h3>Loading...</h3></div>
                            <table id="service" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="timeperiod">
                            <div id="loading"><h3>Loading...</h3></div>
                            <table id="timeperiod" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="span3">
                <div class="block">
                    <div>
                        <ul class="nav nav-list">
                            <li class="nav-header">Actions</li>
                            <li class="dropdown">
                                <a class="dropdown-toggle"
                                   data-toggle="dropdown"
                                   href="#">
                                    <i class="icon-plus-sign"></i> Add Object
                                </a>

                                <ul class="dropdown-menu">
                                    <li class="nav-header">Objects</li>
                                    <li><a href="add/command"><i class="glyph-computer-proces"></i> Command</a></li>
                                    <li><a href="add/contact"><i class="glyph-woman"></i> Contact</a></li>
                                    <li><a href="add/host"><i class="glyph-computer-locked"></i> Host</a></li>
                                    <li><a href="add/service"><i class="glyph-computer-service"></i> Service</a></li>
                                    <li><a href="add/timeperiod"><i class="glyph-clock"></i> Timeperiod</a></li>
                                    <li class="nav-header">Object Groups</li>
                                    <li><a href="add/contactgroup"><i class="glyph-adress-book"></i> Contactgroup</a></li>
                                    <li><a href="add/hostgroup"><i class="glyph-more-items"></i> Hostgroup</a></li>
                                    <li><a href="add/servicegroup"><i class="glyph-more-items"></i> Servicegroup</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div id="bulk">
                        <ul class="nav nav-list">
                            <li class="nav-header">Bulk Actions</li>
                            <li><a href="/objectbrowser/bulk/delete"><i class="icon-trash"></i> Delete</a></li>
                            <li><a href="/objectbrowser/edit_many"><i class="glyph-pencil"></i> Update Field</a></li>
                        </ul>
                    </div>

                </div>

                <div class="block">
                    <h4>Object Counts</h4>
                    <table style="width: 100%" id="objectoverview">
                        <thead>
                        <tr>
                            <th>Type</th>
                            <th>#</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for i in object_types %}
                            <tr class="{% cycle 'even' 'odd' %}">
                                <td><strong>{{ i.name }}</strong></td>
                                <td class="center">{{ i.active }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </div>
                <div class="block hide" id="log" style="height: 150px;overflow: auto">

                </div>
            </div>

        </div>


    {% else %}
        <p>List of object types not found </p>
    {% endif %}

    <div class="row">
        <div class="span12">
            <div class="block">
                <h5 style="border-bottom: 1px solid #ccc">Most Recent Changes</h5>
                <table class="log">
                    <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>What</th>
                    </tr>
                    </thead>
                    <tbody>

                    {% for logentry in gitlog %}
                        <tr>
                            <td>{{ logentry.authortime|date:"j M Y, H:i" }}</td>
                            <td>{{ logentry.author }} &lt;{{ logentry.authoremail }}&gt;</td>
                            <td>{{ logentry.comment }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
