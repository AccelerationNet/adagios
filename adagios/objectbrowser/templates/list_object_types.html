{% extends "base.html" %}

{% block title %}Adagios - Object Browser{% endblock %}
{% block footer %}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">

    var currenttab = '#service';
    var currenttable = '#servicetable';


    $(document).ready(function() {
        /* Default class modification */
        $.extend( $.fn.dataTableExt.oStdClasses, {
            "sSortAsc": "header headerSortDown",
            "sSortDesc": "header headerSortUp",
            "sSortable": "header"
        } );

        // Show service tab
        $('#objecttabs a:[href="#service"]').tab('show');

        /*
        Create the command table and populate it
         */
        $('#commandtable').adagios_ob_dataTable(
                [
                    { "sTitle": "Command Name" },
                    { "sTitle": "Command Line" }
                ]
        ).adagios_ob_dtPopulate('command',
                [
                    {
                        "cName": "command_name",
                        "icon": "glyph-computer-proces"
                    },
                    {
                        "cName": "command_line",
                        "truncate": 40
                    }
                ]
        );



        /* Create the CONTACT objec datatable */
        $('#contacttable').adagios_ob_dataTable(
                [
                    { "sTitle": "Contact Name" },
                    { "sTitle": "Alias" },
                    { "sTitle": "E-Mail" }
                ]
        ).adagios_ob_dtPopulate('contact',
                [
                    {
                        "cName": "contact_name",
                        "cAltName": "name",
                        "icon": "glyph-woman"
                    },
                    { "cName": "alias" },
                    { "cName": "email" }
                ]
        ).adagios_ob_dtPopulate('contactgroup',

                [
                    {
                        "cName": "contactgroup_name",
                        "cAltName": "name",
                        "icon": "glyph-adress-book"
                    },
                    { "cName": "alias" },
                    { "cName": "email" }
                ]
        );


        /* Create the CONTACT objec datatable */
        $('#hosttable').adagios_ob_dataTable(
                [
                    { "sTitle": "Name" },
                    { "sTitle": "Address" },
                    { "sTitle": "Alias" }
                ]
        ).adagios_ob_dtPopulate('host',
                [
                    {
                        "cName": "host_name",
                        "cAltName": "name",
                        "icon": "glyph-computer-locked"
                    },
                    { "cName": "address" },
                    { "cName": "alias" }
                ]
        ).adagios_ob_dtPopulate('hostgroup',
                [
                    {
                        "cName": "hostgroup_name",
                        "cAltName": "name",
                        "icon": "glyph-more-items"
                    },
                    { "cName": "address" },
                    { "cName": "alias" }
                ]
        );


        $('table#servicetable').adagios_ob_dataTable(
            [
                { "sTitle": "Name" },
                { "sTitle": "Host" },
                { "sTitle": "Command" }
            ]).adagios_ob_dtPopulate('service', [
            {
                "cName": "service_description",
                "cAltName": "name",
                "icon": "glyph-computer-service"
            },
            { "cName": "host_name" },
            {
                "cName": "check_command",
                "truncate": 16
            }
        ]).adagios_ob_dtPopulate('servicegroup', [
            {
                "cName": "servicegroup_name",
                "cAltName": "name",
                "icon": "glyph-more-items"
            },
            { "cName": "host_name" },
            { "cName": "check_command" }
        ]);



        $('#timeperiodtable').adagios_ob_dataTable(
            [
                { "sTitle": "Name" },
                { "sTitle": "Alias" }
            ]).adagios_ob_dtPopulate('timeperiod', [
            {
                "cName": "timeperiod_name",
                "cAltName": "name",
                "icon": "glyph-clock"
            },
            { "cName": "alias" }
        ]);

        $(window).bind('resize', function () {
            /* This blows, couldn't find a good way to do this - tommi */
            $(currenttable).dataTable().fnAdjustColumnSizing();
            $(currenttab).tab('show');
        } );

        $('a[data-toggle="tab"]').on('shown', function (e) {
            currenttab = $(e.target).attr('href');
            currenttable = $(e.target).attr('href') + 'table';
            /* For some reason I have to loop through everything, weird.
             $(currenttable).dataTable().fnAdjustColumnSizing();
             */
            $(currenttable).dataTable().fnAdjustColumnSizing();
            /*
             var tables = $.fn.dataTable.fnTables();
             for ( var i = 0 ; i<tables.length ; i++ ) {
             $(tables[i]).dataTable().fnAdjustColumnSizing(true);
             }
             */
            $('#log').append("Set current tab " + currenttable + '<br/>');
            // e.target // activated tab
            // e.relatedTarget // previous tab

        });


    } );

    </script>
{% endblock %}
{% block content %}

    <div class="row">
        <div class="span12">
            <div class="block">
                <ul class="breadcrumb">
                    <li>
                        <a href="{{ BASE_URL }}">Home</a> <span class="divider">/</span>
                    </li>
                </ul>
                <h2>
                    <i class="icon-th-large"></i> <small>Object</small> Browser
                </h2>

            </div>
        </div>
    </div>
    {% if object_types %}

        <div class="row">
            <div class="span9">
                <div class="block">
                    <ul class="nav nav-tabs" id="objecttabs">
                        <li><a href="#command" data-toggle="tab">Commands</a></li>
                        <li><a href="#contact" data-toggle="tab">Contacts</a></li>
                        <li><a href="#host" data-toggle="tab">Hosts</a></li>
                        <li><a href="#service" data-toggle="tab">Services</a></li>
                        <li><a href="#timeperiod" data-toggle="tab">Timeperiods</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane" id="command">
                            <table id="commandtable" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="contact">
                            <table id="contacttable" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="host">
                            <table id="hosttable" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="service">
                            <table id="servicetable" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="timeperiod">
                            <table id="timeperiodtable" class="table table-striped">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="span3">
                <div class="block">
                    <h5>Actions</h5>
                    <div class="btn-group">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="icon-plus-sign"></i> Add Object
                        </a>
                        <ul class="dropdown-menu">
                            <li><h5 class="center">Objects</h5></li>
                            <li><a href="/add/host"><i class="glyph-computer-proces"></i> Command</a></li>
                            <li><a href="/add/host"><i class="glyph-woman"></i> Contact</a></li>
                            <li><a href="/add/host"><i class="glyph-computer-locked"></i> Host</a></li>
                            <li><a href="/add/host"><i class="glyph-computer-service"></i> Service</a></li>
                            <li><a href="/add/host"><i class="glyph-clock"></i> Timeperiod</a></li>
                            <li><h5 class="center">Object Groups</h5></li>
                            <li><a href="/add/host"><i class="glyph-adress-book"></i> Contact</a></li>
                            <li><a href="/add/host"><i class="glyph-more-items"></i> Host</a></li>
                            <li><a href="/add/host"><i class="glyph-more-items"></i> Service</a></li>
                        </ul>
                    </div>
                    <div id="bulk" class="hide">
                        <h5>Bulk Actions</h5>
                        <ul class="nav nav-list">
                            <li><a href="/objectbrowser/bulk/delete"><i class="icon-trash"></i> Delete</a></li>
                            <li><a href="/objectbrowser/bulk/update"><i class="glyph-pencil"></i> Update Field</a></li>
                        </ul>
                    </div>

                </div>

                <div class="block">
                    <table style="width: 100%" id="objectoverview">
                        <thead>
                        <tr>
                            <th>Type</th>
                            <th>Active</th>
                            <th>Inactive</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for i in object_types %}
                            <tr class="{% cycle 'even' 'odd' %}">
                                <td><a href="search?object_type={{ i.name }}">{{ i.name }}</a></td>
                                <td class="center"><a href="search?object_type={{ i.name }}&register=1">{{ i.active }}</a></td>
                                <td class="center"><a href="search?object_type={{ i.name }}&register=0">{{ i.inactive }}</a></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </div>
                <div class="block" id="log" style="height: 150px;overflow: auto">

                </div>
            </div>

        </div>


    {% else %}
        <p>List of object types not found </p>
    {% endif %}

    <div class="row">
        <div class="span12">
            <div class="block">
                <h5 style="border-bottom: 1px solid #ccc">Most Recent Changes</h5>
                <table class="log">
                    <thead>
                    <th>Time</th>
                    <th>User</th>
                    <th>What</th>
                    </thead>
                    <tbody>

                    {% for logentry in gitlog %}
                        <tr>
                            <td>{{ logentry.authortime|date:"j M Y, H:i" }}</td>
                            <td>{{ logentry.author }} &lt;{{ logentry.authoremail }}&gt;</td>
                            <td>{{ logentry.comment }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
