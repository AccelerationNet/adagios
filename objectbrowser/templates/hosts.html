{% extends "configurator/base.html" %}
{% block head %}

		<script type="text/javascript" src="/static/js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" src="/static/js/jquery.url.packed.js"></script>

{% endblock %}
{% block javascript %}


var currentTable = '';
var currentTemplateTable = '';
var currentTabId = 0;



tabs = [
	{ 
		'title': 'Contacts', 
		'id': 'contact',
		'columns': ['contact_name', 'email', 'alias'],
		'columnheadings': ['Contact Name', 'E-Mail', 'Description'],
		},
	{
		'title': 'Hosts',
		'id': 'host',
		'columns': ['host_name', 'address', 'alias'],
		'columnheadings': ['Hostname', 'IP Address', 'Description']
		},
	{
		'title': 'Services',
		'id': 'service',
		'columns': ['host_name', 'service_description'],
		'columnheadings': ['Hostname', 'Service']
		},
	{
		'title': 'Timeperiods',
		'id': 'timeperiod',
		'columns': ['timeperiod_name', 'alias'],
		'columnheadings': ['Timeperiod', 'Description']
		},
	{
		'title': 'Commands',
		'id': 'command',
		'columns': ['command_name'],
		'columnheadings': ['Command Name']
		},
	{
		'title': 'Contactgroups',
		'id': 'contactgroup',
		'columns': ['contactgroup_name', 'alias'],
		'columnheadings': ['Contactgroup Name', 'Description']
		},
	{
		'title': 'Hostgroups',
		'id': 'hostgroup',
		'columns': ['hostgroup_name', 'alias'],
		'columnheadings': ['Hostgroup Name', 'Description']
		},
	{
		'title': 'Servicegroups',
		'id': 'servicegroup',
		'columns': ['servicegroup_name', 'alias'],
		'columnheadings': ['Servicegroup Name', 'Description']
		},
];


$(document).ready(function() {

	// Get the anchor URI parameter (eg host, service...)
	if (document.location.href.split('#')[1] != null) {
		currentTable = document.location.href.split('#')[1];
	// Get the  URL parameter (eg host, service...)
	} else if (jQuery.url.segment(1) != null) {
		currentTable = jQuery.url.segment(1);
	} else {
		currentTable = 'hostgroup';
	}
	createTabs();
	populateListTable();
});


// Creates the tabs from array map defined above
function createTabs() {
	for (var i=0; i < tabs.length; i++) {
		if (tabs[i]['id'] == currentTable) {
			currentTabId = i;
		}
		// Add tab name
		$('#objecttabs > ul').append('<li><a href="#' + tabs[i]['id'] + '">' + tabs[i]['title'] + '</a></li>');
		$('#objecttabs').append('<div id="' + tabs[i]['id'] + '"></div>');	
	}
	$tabs = $('#objecttabs').tabs();
	$('#objecttabs ul li a').click(function () {location.hash = $(this).attr('href');}); 
	$tabs.tabs('select', currentTabId);
	$('#objecttabs').bind( "tabsselect", function(e, ui) {
		currentTable = ui.panel.id;
		currentTabId = ui.index;
		populateListTable();
		return true;
	});
}


function populateListTable() {
	listtype = currentTable
	// Table does not exist, create it and fetch data
	if ($('#listtable-' + listtype).length == 0) {
		// Create the object table
		$('#' + listtype).html('<div id="container-' + listtype + '"></div>');
		$('#container-' + listtype).html('<table id="listtable-' + listtype + '"><thead></thead><tbody></tbody></table><table id="listtable-template-' + listtype + '" class="listtable_template"><thead></thead><tbody></tbody></table>');

		// Record the current tabproperties from the tabs array
		tabProps = tabs[currentTabId];
		$('#container-' + listtype)
			.hide()
			.ajaxStart(function() {
			})
			.ajaxStop(function() {
				currentTable.fnAdjustColumnSizing();
			});
		
		// Create the heading row
		$('#listtable-' + listtype + ' > thead').append('<tr></tr>');
		for (var i=0; i<tabProps['columns'].length; i++) {
			$('#listtable-' + listtype + ' > thead > tr').append('<th>' + tabProps['columnheadings'][i] + '</th>');
		}
		// Create the template heading row
		$('#listtable-template-' + listtype + ' > thead').append('<tr></tr>');
		$('#listtable-template-' + listtype + ' > thead > tr').append('<th>Name</th>');

		// Activate the dataTable plugin
		currentdataTable = $('#listtable-' + listtype).dataTable( {
			"sScrollY": "400px",
			"bScrollCollapse": true,
			"bPaginate": false,
			"bJQueryUI": true,
		});
		
		// Activate the dataTable plugin for the template table
		currentTemplatedataTable = $('#listtable-template-' + listtype).dataTable( {
			"sScrollY": "400px",
			"bScrollCollapse": true,
			"bPaginate": false,
			"bJQueryUI": true,
		});
		var objectrows = [];
		var templaterows = [];
		
		$.ajax({
			url: '/rest/pynag/json/get_objects',
			data: {  object_type: listtype, with_fields: tabProps['columns'].join(",") + ',id,name' },
			dataType: 'json',
			type: 'POST',
			success: function(data) {
				tabProps = tabs[currentTabId];
				$.each(data, function(key, val) {
					var row = [];
					if (val[tabProps['columns'][0]] == undefined) {
						row.push('<strong>' + val['name'] + '</strong>');
						templaterows.push(row);
						return true;
					} else {
						row.push('<a href="/objectbrowser/id=' + val['id'] + '">' + val[tabProps['columns'][0]] + '</a>');
					}
					for (var i=1; i<tabProps['columns'].length; i++) {
						// Put a space into empty
						if (val[tabProps['columns'][i]] == undefined) {
							row.push('&nbsp;');
						// The actual data
						} else {
							var value = val[tabProps['columns'][i]];
							row.push('<a href="/objectbrowser/id=' + val['id'] + '">' + value + '</a>');
						}
					}
					// Push on my 2 dimensional array
					objectrows.push(row);

					return true;
				});
				$('#container-' + listtype).show();
				// Finally add the rows to the DataTable
				currentdataTable.fnAddData(objectrows);
				currentdataTable.fnAdjustColumnSizing();
				if (templaterows.length != 0) {
					currentTemplatedataTable.fnAddData(templaterows);
					currentTemplatedataTable.fnAdjustColumnSizing();
				} else {
					$('#listtable-template-' + listtype + '_wrapper').hide();
				}
				return true;
			}
		});
	}
	return true;
}

{% endblock %}
{% block content %}
	<div id="objecttabs">
		<ul>
		</ul>
	</div>
{% endblock %}